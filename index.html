<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colectivos - Formosa</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css" integrity="sha256-sA+zWATbFveLLNqWO2gtiw3HL/lh1giY/Inf1BJ0z14=" crossorigin="" />
    <link rel="stylesheet" href="css/micss.css"></link>
    <script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js" integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg=" crossorigin=""></script>
</head>
<body>
    <header class="header">
        
          <button class='mi_boton' onclick='detectarMiPosicion();'>
              Donde estoy
          </button>
          
         <div class='contenedor_lista'>
          <input id="buscar" type="text" >
          <ul id='lista_barrios' class='lista_barrios oculto'></ul>
         </div>
       
    </header>
    <div id='map' class='mi_mapa'>

    </div>

    <script src="js/afsa-barrios.js"></script>
    <script>
         var latlngs=[];
        var map = L.map('map',{renderer: L.canvas()}).setView([-26.175569, -58.179647], 13);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                    }).addTo(map);

        var point;
        
        // navigator.geolocation.getCurrentPosition((position) => {
        //     let lat = position.coords.latitude;
        //     let long = position.coords.longitude;

        //     var point = L.point(lat, long);
        //     console.log(point);
        // });
        
        var point = L.latLng(-26.1521408, -58.1435392);
        barrios.features.forEach(elemento => {
          
            latlngs=L.GeoJSON.coordsToLatLngs(elemento.geometry.coordinates[0]);
            
            var poligon=L.polygon(latlngs, {color: 'red',weigth:0.5}).addTo(map);
            var myIcon = L.divIcon({className: 'my-div-icon',html:"<span class='milabel'>"+elemento.properties['NOMBRE']+"</span>"});

            
            L.marker(poligon.getBounds().getCenter(), {icon: myIcon}).addTo(map);
           
         
        });

        map.on('click', establecerDestino);

        function establecerDestino(e){
          //e.latlngs;
          var destino = L.marker(e.latlng).addTo(map);
          barrios.features.forEach(elemento => {
              
            latlngs=L.GeoJSON.coordsToLatLngs(elemento.geometry.coordinates[0]);
              
            var poligon=L.polygon(latlngs, {color: 'red'})

            if(poligon.getBounds().contains(e.latlng)){
              

              console.log(elemento.properties['NOMBRE']);

            }
          });
        }

        var miubicacion;
        function detectarMiPosicion(){
          navigator.geolocation.getCurrentPosition((position) => {

              let lat = position.coords.latitude;
              let long = position.coords.longitude;

               miubicacion = L.latLng(lat, long);
               barrios.features.forEach(elemento => {
          
                  latlngs=L.GeoJSON.coordsToLatLngs(elemento.geometry.coordinates[0]);
                  
                  var poligon=L.polygon(latlngs, {color: 'red'})

                  if(poligon.getBounds().contains(miubicacion)){
                    var marker = L.marker(miubicacion).addTo(map);
                    console.log('coordenadas'+miubicacion);
                    console.log('si');
                    console.log(elemento.properties['NOMBRE']);
                    console.log(poligon.getBounds());
                    alert(elemento.properties['NOMBRE']);
                  }
              });
          },function(e){},{
              enableHighAccuracy: true,
              timeout: 5000,
              maximumAge: 0
            });

        }

     
        document.getElementById('buscar').addEventListener('input',buscar);
        document.addEventListener('keydown',navegarConLasTeclas);

        var elementos_coinciden=[];
        function buscar(e){
        
          var palabra_buscada=document.getElementById('buscar').value.toUpperCase();

          if (palabra_buscada!=''){
            document.getElementById('lista_barrios').classList.remove("oculto");
          }else{
            document.getElementById('lista_barrios').classList.add("oculto");
          }

          elementos_coinciden=[];

          barrios.features.forEach(elemento => {
          
            if (elemento.properties['NOMBRE'].includes(palabra_buscada)){
              elementos_coinciden.push(elemento);

            }
           
          });

          dubujarLista(elementos_coinciden);
        }

        var elementoListaSeleccionado=0;
        function navegarConLasTeclas(e){


          
          switch (e.key) {
            
              case 'ArrowUp':
                    todos_los_elementos_lista[elementoListaSeleccionado].classList.remove('seleccionado');
                    if (elementoListaSeleccionado>0) {
                     
                      elementoListaSeleccionado--;
                     
                    };
                    todos_los_elementos_lista[elementoListaSeleccionado].classList.add('seleccionado');
                  break;
              case 'ArrowDown':
                  
                  todos_los_elementos_lista[elementoListaSeleccionado].classList.remove('seleccionado');
                   if (elementoListaSeleccionado<(todos_los_elementos_lista.length-1)){
                    elementoListaSeleccionado++;
                  };
                  todos_los_elementos_lista[elementoListaSeleccionado].classList.add('seleccionado');
                  break;
            
              case 'Enter':
                  todos_los_elementos_lista[elementoListaSeleccionado].click();
                  elementoListaSeleccionado=0;
              break;
          }
     
        

        }

        var todos_los_elementos_lista;
        function dubujarLista(elementos_coinciden){

    

          var html= "";
          
          for (i=0;i<=elementos_coinciden.length-1; i++){
          
            html+="<li tabindex='0' id='li"+i+1+"' onclick='focusBarrio("+i+");'>"+elementos_coinciden[i].properties['NOMBRE']+"</li>";

            if(i==4){break;}
          }
          
          var lista = document.getElementById('lista_barrios');       
          while(lista.firstChild){
              lista.removeChild(lista.firstChild);
          }

            lista.insertAdjacentHTML('beforeend', html);
            
            todos_los_elementos_lista=document.querySelectorAll('.lista_barrios li');
            
        }

        function focusBarrio(i){
          document.getElementById('lista_barrios').classList.add("oculto");
          var centro_barrio=L.polygon(L.GeoJSON.coordsToLatLngs(elementos_coinciden[i].geometry.coordinates[0])).getBounds().getCenter();
          map.setView(centro_barrio, 15, { animation: true });   
        }

    </script>
</body>
</html>