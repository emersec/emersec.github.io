<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css" >

	<!-- LEAFLET CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
   integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
   crossorigin=""/>

   <!-- LEAFLET JAVASCRIPT -->
 	<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
   integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
   crossorigin=""></script>

    <title>Emer-Sec</title>
	
	<!-- Fuente del titulo de la pagina -->
    <link rel="stylesheet" type="text/css" href="estilos.css">
  </head>
  <body onload="cargarBarrios();">
<!-- Modal Segundo-->
<div class="modal fade" id="modalTiempo" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTiempoTitulo">Horario</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="container-fluid " id="modaltiempobody">
          <div class="alert alert-primary" role="alert" id="alert_horario">
          El horario programado para el barrio <a href="#" class="alert-link">BARRIO</a> es de <a href="#" class="alert-link">LUNES A VIERNES </a> a las 6 am
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="" id="defaultCheck1">
          <label class="form-check-label" for="defaultCheck1">
            Notificarme cuando falte 30 minutos
          </label>
        </div>
        <!--<button type="button" class="btn btn-info ">Ver en Tiempo Real</button>-->
          
        </div>
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btn_horario_aceptar">Aceptar</button>
      </div>
    </div>
  </div>
</div>



<!-- Modal Inicio Barrio -->
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalCenterTitle">Seleccione su barrio</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
		<div class="container-fluid">
			<!--select   -->
			<div class="input-group mb-0">
				<div class="input-group-prepend">
					<label class="input-group-text" for="inputGroupSelect01">Barrio</label>
				</div>
				<select class="custom-select" id="barrios">
					<option selected>Elija una opcion...</option>
					
				</select>
			</div>
			
		</div>
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btn_aceptar_barrio">Aceptar</button>
      </div>
    </div>
  </div>
</div>
 <!-- Modal fin -->

 <!-- Mapa Leaflet -->
 <div class="jumbotron text-center danger bg-danger mb-2" style="padding-top: 1%;padding-bottom:1%;">
  		<h1 class="text-light titulo">EMER-SEC</h1>
  		
</div>
<!-- Mapa Leaflet inicio -->
<div class="container-fluid">
 	 	<div class="row ">
    		<div class="col-md-12 col-lg-12">
    			<div id="map" style="height: 500px;width:100%;  "></div>
    		</div>
  		</div>
  		
</div>
<!-- Mapa Leaflet fin  height: 500px; -->


	

	
    

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script
    src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
    crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script type="text/javascript" >
    	let params = new URLSearchParams(location.search);

		var lat=params.get('lat');
		var lon=params.get('lon');
		var nombre=params.get('n');	
		var map = L.map('map').setView([lat, lon], 16);

		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(map);

		var greenIcon = new L.Icon({
			iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
			shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			iconSize: [25, 41],
			iconAnchor: [12, 41],
			popupAnchor: [1, -34],
			shadowSize: [41, 41]
		});


		var marker=L.marker([lat, lon], {icon: greenIcon}).addTo(map);
		marker.bindPopup("<b> "+nombre+"</b>").openPopup();

		


		

	</script>

  
  
  <!-- barrios -->
  <script type="text/javascript" >

    function cargarBarrios(){
      $.ajax({url: "./php/barrios.php", success: function(respuesta){
        $("#barrios").append(respuesta);
        $('#exampleModalCenter').modal('show');
      }});
    }


    //Boton Aceptar de seleccionar Barri
    $('#btn_aceptar_barrio').on('click',function(){
        $('#exampleModalCenter').modal('hide');
        
        var day= new Date().getDay()+1;
        var id_barrio=document.getElementById("barrios").value;
        obtenerHorario(day,id_barrio);

        $('#exampleModalCenter').on('hidden.bs.modal', function (e) {
            $('#modalTiempo').modal('show');
        });
    });

    function obtenerHorario(dia,barrio){
       $.ajax({url: "./php/obtenerHorario.php",data:{"dia":dia,"barrio":barrio},
        type:"GET", 
        success: function(respuesta){
        respuesta=JSON.parse(respuesta);

        
        $('#alert_horario')
        .html(construirInterfazHorario(respuesta.HORA,barrio));
      }});
    }



  function construirInterfazHorario(hora,barrio){
    var hora=calcularHora(hora);
    if (hora<0){return "El camion recolector ya ha pasado por el barrio <Strong>" +barrio + "</Strong> hoy. Vea los <a href=# class='alert-link'> Horarios de recoleccion </a> para mas informacion";}
    if (hora==0) {"El camion recolector pasar√° dentro de <strong>" + new Date().getMinutes() + " minutos</strong> por el barrio <strong> "+barrio+"</strong> segun el horario programado"; }
    
    return "El camion recolector pasara dentro de <strong>" + hora + " horas </strong> por el barrio <strong> "+barrio+"</strong> segun el horario programado";


  }




  function calcularHora(horaDeRecoleccion){
    var horaActual=new Date().getHours();
    horaDeRecoleccion=horaDeRecoleccion -horaActual;

    return horaDeRecoleccion
  }

  //--------------------------------------------------------
   $("#btn_horario_aceptar").on("click",function(data){
    $("#modalTiempo").modal("hide");
   })

  </script>
  </body>
</html>